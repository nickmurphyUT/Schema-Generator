<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ title or "Schema App Dashboard" }}</title>
    <!-- Load Tailwind CSS via CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom font import for aesthetics */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body { font-family: 'Inter', sans-serif; }
        /* Style for the select element options */
        .select-field {
            padding: 4px 8px;
            border-radius: 4px;
            border: 1px solid #d1d5db;
            background-color: white;
            transition: all 0.15s;
        }
        .select-field:focus {
            border-color: #005bd3;
            box-shadow: 0 0 0 2px rgba(0, 91, 211, 0.2);
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
<div class="max-w-7xl mx-auto px-6 py-4">
  <label class="text-sm font-medium text-gray-600 mr-2">
    Select schema type:
  </label>

  <select
    id="schemaSectionSelect"
    class="select-field"
  >
    <option value="product">Product</option>
    <option value="collection">Collection</option>
    <option value="blog">Blog</option>
    <option value="page">Page</option>
    <option value="homepage">Homepage</option>
  </select>
</div>

<!-- PRODUCT SCHEMA MAPPING UI -->
<div id="section-product" class="bg-white rounded-xl p-6 shadow-lg border border-gray-100 mb-8">

    <h3 class="text-2xl font-semibold text-gray-700 mb-6 border-b pb-3">
        Product Schema Generator
    </h3>

    <!-- Empty container for mapping rows -->
    <div id="schema-mapping-container" class="space-y-4 mb-6">
        <!-- rows injected dynamically -->
    </div>

    <button id="addMappingBtn"
        class="bg-blue-600 hover:bg-blue-700 text-white py-2 px-4 rounded-lg shadow">
        + Add Schema Mapping
    </button>

    <button id="sendToBackendBtn"
        class="bg-green-600 hover:bg-green-700 text-white py-2 px-4 rounded-lg shadow mt-4">
        Save & Generate Schema Metafields
    </button>

    <!-- Status preview -->
    <div id="metafields-preview" class="mt-4 text-sm text-gray-500"></div>

</div>
    <!-- COLLECTION SCHEMA MAPPING UI -->
<div id="section-collection" class="bg-white rounded-xl p-6 shadow-lg border border-gray-100 mb-8">

    <h3 class="text-2xl font-semibold text-gray-700 mb-6 border-b pb-3">
        Collection Schema Generator
    </h3>

    <div id="collection-mapping-container" class="space-y-4 mb-6"></div>

    <button id="addCollectionBtn"
        class="bg-blue-600 hover:bg-blue-700 text-white py-2 px-4 rounded-lg shadow">
        + Add Schema Mapping
    </button>

    <button id="saveCollectionBtn"
        class="bg-green-600 hover:bg-green-700 text-white py-2 px-4 rounded-lg shadow mt-4">
        Save & Generate Collection Schema Metafields
    </button>

    <div id="collection-preview" class="mt-4 text-sm text-gray-500"></div>
</div>

    <!-- BLOG SCHEMA MAPPING UI -->
<div id="section-blog" class="bg-white rounded-xl p-6 shadow-lg border mb-8">
  <h3 class="text-2xl font-semibold text-gray-700 mb-6 border-b pb-3">
    Blog Schema Generator
  </h3>

  <div id="blog-mapping-container" class="space-y-4 mb-6"></div>

  <button id="addBlogBtn"
    class="bg-blue-600 hover:bg-blue-700 text-white py-2 px-4 rounded-lg shadow">
    + Add Schema Mapping
  </button>

  <button id="saveBlogBtn"
    class="bg-green-600 hover:bg-green-700 text-white py-2 px-4 rounded-lg shadow mt-4">
    Save & Generate Blog Schema Metafields
  </button>

  <div id="blog-preview" class="mt-4 text-sm text-gray-500"></div>
</div>



        <!-- PAGE SCHEMA MAPPING UI -->
<div id="section-page" class="bg-white rounded-xl p-6 shadow-lg border mb-8">
  <h3 class="text-2xl font-semibold text-gray-700 mb-6 border-b pb-3">
    Page Schema Generator
  </h3>

  <div id="page-mapping-container" class="space-y-4 mb-6"></div>

  <button id="addPageBtn"
    class="bg-blue-600 hover:bg-blue-700 text-white py-2 px-4 rounded-lg shadow">
    + Add Schema Mapping
  </button>

  <button id="savePageBtn"
    class="bg-green-600 hover:bg-green-700 text-white py-2 px-4 rounded-lg shadow mt-4">
    Save & Generate Page Schema Metafields
  </button>

  <div id="page-preview" class="mt-4 text-sm text-gray-500"></div>
</div>


    <!-- HOMEPAGE SCHEMA MAPPING UI -->
<div id="section-homepage" class="bg-white rounded-xl p-6 shadow-lg border mb-8">
  <h3 class="text-2xl font-semibold text-gray-700 mb-6 border-b pb-3">
    Homepage Schema Generator
  </h3>

  <div id="homepage-mapping-container" class="space-y-4 mb-6"></div>

  <button id="addHomepageBtn"
    class="bg-blue-600 hover:bg-blue-700 text-white py-2 px-4 rounded-lg shadow">
    + Add Schema Mapping
  </button>

  <button id="saveHomepageBtn"
    class="bg-green-600 hover:bg-green-700 text-white py-2 px-4 rounded-lg shadow mt-4">
    Save & Generate Homepage Schema Metafields
  </button>

  <div id="homepage-preview" class="mt-4 text-sm text-gray-500"></div>
</div>
<script>
/* ================= GLOBAL STATE ================= */
let mappings = [];
let collectionMappings = [];
let blogMappings = [];
let pageMappings = [];
let homeMappings = [];

let rowIdCounter = 0;
let collectionRowId = 0;
let blogRowId = 0;
let pageRowId = 0;

/* ================= FIELD OPTIONS ================= */
const productFieldOptions = [
  "product.title",
  "product.vendor",
  "product.handle",
  "product.product_type",
  "product.status",
  "product.description",
  "product.tags[]",
  "product.images[].src",
  "variants[].sku",
  "variants[].price",
  "variants[].barcode",
  "variants[].weight",
  {% for mf in product_metafields %}
  "metafield: {{ mf.node.namespace }}.{{ mf.node.key }}",
  {% endfor %}
];

const collectionFieldOptions = [
  "collection.title",
  "collection.handle",
  "collection.sort_order",
  "collection.updated_at",
  {% for mf in collection_metafields %}
  "metafield: {{ mf.node.namespace }}.{{ mf.node.key }}",
  {% endfor %}
];

const blogFieldOptions = [
  "blog.title",
  "blog.handle",
  "blog.url",
  {% for mf in blog_metafields %}
  "metafield: {{ mf.node.namespace }}.{{ mf.node.key }}",
  {% endfor %}
];

const pageFieldOptions = [
  "page.title",
  "page.handle",
  "page.url",
  {% for mf in page_metafields %}
  "metafield: {{ mf.node.namespace }}.{{ mf.node.key }}",
  {% endfor %}
];

const homepageFieldOptions = [
  "shop.name",
  "shop.domain",
  "shop.primary_domain",
  "shop.email",
  "shop.currency",
  "shop.description"
];

const commonSchemaFields = {{ org_schema_fields | tojson }};

console.log("ðŸ§  Loaded field options", {
  productFieldOptions,
  collectionFieldOptions,
  blogFieldOptions,
  pageFieldOptions
});

/* ================= GENERIC HELPERS ================= */
function ensureOption(options, value) {
  return value && !options.includes(value)
    ? [...options, value]
    : [...options];
}

/* ================= PRODUCT ================= */
function createSchemaRow(defaultSchema = "", defaultSource = "") {
  const schemaOptions = ensureOption(commonSchemaFields, defaultSchema);
  const sourceOptions = ensureOption(productFieldOptions, defaultSource);

  const container = document.getElementById("schema-mapping-container");
  const row = document.createElement("div");

  row.className = "flex gap-4 bg-gray-50 p-4 rounded-lg border";
  row.innerHTML = `
    <select class="schema-select p-2 border rounded">
      <option value="">Schema Field</option>
      ${schemaOptions.map(o => `<option ${o===defaultSchema?"selected":""}>${o}</option>`).join("")}
    </select>

    <select class="product-source p-2 border rounded">
      <option value="">Product Source</option>
      ${sourceOptions.map(o => `<option ${o===defaultSource?"selected":""}>${o}</option>`).join("")}
    </select>

    <button class="delete-row bg-red-500 text-white px-3 rounded">X</button>
  `;

  row.querySelector(".delete-row").onclick = () => { row.remove(); updateMappings(); };
  row.querySelectorAll("select").forEach(el => el.onchange = updateMappings);

  container.appendChild(row);
  updateMappings();
}

function updateMappings() {
  mappings = [...document.querySelectorAll("#schema-mapping-container > div")].map(row => ({
    schemaField: row.querySelector(".schema-select").value,
    sourceField: row.querySelector(".product-source").value
  })).filter(m => m.schemaField && m.sourceField);

  console.log("ðŸ“¦ Product mappings", mappings);
}

/* ================= COLLECTION ================= */
function createCollectionRow(defaultSchema="", defaultSource="") {
  const schemaOptions = ensureOption(commonSchemaFields, defaultSchema);
  const sourceOptions = ensureOption(collectionFieldOptions, defaultSource);

  const container = document.getElementById("collection-mapping-container");
  const row = document.createElement("div");

  row.className = "flex gap-4 bg-gray-50 p-4 rounded-lg border";
  row.innerHTML = `
    <select class="collection-schema p-2 border rounded">
      <option value="">Schema</option>
      ${schemaOptions.map(o=>`<option ${o===defaultSchema?"selected":""}>${o}</option>`).join("")}
    </select>

    <select class="collection-source p-2 border rounded">
      <option value="">Collection Source</option>
      ${sourceOptions.map(o=>`<option ${o===defaultSource?"selected":""}>${o}</option>`).join("")}
    </select>

    <button class="delete bg-red-500 text-white px-3 rounded">X</button>
  `;

  row.querySelector(".delete").onclick = () => { row.remove(); updateCollectionMappings(); };
  row.querySelectorAll("select").forEach(el => el.onchange = updateCollectionMappings);

  container.appendChild(row);
  updateCollectionMappings();
}

function updateCollectionMappings() {
  collectionMappings = [...document.querySelectorAll("#collection-mapping-container > div")].map(row => ({
    schemaField: row.querySelector(".collection-schema").value,
    sourceField: row.querySelector(".collection-source").value
  })).filter(m => m.schemaField && m.sourceField);

  console.log("ðŸ“¦ Collection mappings", collectionMappings);
}

/* ================= BLOG ================= */
function createBlogRow(defaultSchema="", defaultSource="") {
  const schemaOptions = ensureOption(commonSchemaFields, defaultSchema);
  const sourceOptions = ensureOption(blogFieldOptions, defaultSource);

  const container = document.getElementById("blog-mapping-container");
  const row = document.createElement("div");

  row.className = "flex gap-4 bg-gray-50 p-4 rounded-lg border";
  row.innerHTML = `
    <select class="blog-schema p-2 border rounded">
      <option value="">Schema</option>
      ${schemaOptions.map(o=>`<option ${o===defaultSchema?"selected":""}>${o}</option>`).join("")}
    </select>

    <select class="blog-source p-2 border rounded">
      <option value="">Blog Source</option>
      ${sourceOptions.map(o=>`<option ${o===defaultSource?"selected":""}>${o}</option>`).join("")}
    </select>

    <button class="delete bg-red-500 text-white px-3 rounded">X</button>
  `;

  row.querySelector(".delete").onclick = () => { row.remove(); updateBlogMappings(); };
  row.querySelectorAll("select").forEach(el => el.onchange = updateBlogMappings);

  container.appendChild(row);
  updateBlogMappings();
}

function updateBlogMappings() {
  blogMappings = [...document.querySelectorAll("#blog-mapping-container > div")].map(row => ({
    schemaField: row.querySelector(".blog-schema").value,
    sourceField: row.querySelector(".blog-source").value
  })).filter(m => m.schemaField && m.sourceField);

  console.log("ðŸ“¦ Blog mappings", blogMappings);
}

/* ================= PAGE ================= */
function createPageRow(defaultSchema="", defaultSource="") {
  const schemaOptions = ensureOption(commonSchemaFields, defaultSchema);
  const sourceOptions = ensureOption(pageFieldOptions, defaultSource);

  const container = document.getElementById("page-mapping-container");
  const row = document.createElement("div");

  row.className = "flex gap-4 bg-gray-50 p-4 rounded-lg border";
  row.innerHTML = `
    <select class="page-schema p-2 border rounded">
      <option value="">Schema</option>
      ${schemaOptions.map(o=>`<option ${o===defaultSchema?"selected":""}>${o}</option>`).join("")}
    </select>

    <select class="page-source p-2 border rounded">
      <option value="">Page Source</option>
      ${sourceOptions.map(o=>`<option ${o===defaultSource?"selected":""}>${o}</option>`).join("")}
    </select>

    <button class="delete bg-red-500 text-white px-3 rounded">X</button>
  `;

  row.querySelector(".delete").onclick = () => { row.remove(); updatePageMappings(); };
  row.querySelectorAll("select").forEach(el => el.onchange = updatePageMappings);

  container.appendChild(row);
  updatePageMappings();
}

function updatePageMappings() {
  pageMappings = [...document.querySelectorAll("#page-mapping-container > div")].map(row => ({
    schemaField: row.querySelector(".page-schema").value,
    sourceField: row.querySelector(".page-source").value
  })).filter(m => m.schemaField && m.sourceField);

  console.log("ðŸ“¦ Page mappings", pageMappings);
}

/* ================= PAYLOAD ================= */
function buildFullPayload() {
  return {
    shop: '{{ shop_name }}',
    hmac: '{{ hmac_value }}',
    id_token: '{{ id_token_value }}',
    product_schema_mappings: mappings,
    collection_schema_mappings: collectionMappings,
    blog_schema_mappings: blogMappings,
    page_schema_mappings: pageMappings,
    homepage_schema_mappings: homeMappings
  };
}
</script>


</body>
</html>
