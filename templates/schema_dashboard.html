<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ title or "Schema App Dashboard" }}</title>
    <!-- Load Tailwind CSS via CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .select-field {
            padding: 4px 8px;
            border-radius: 4px;
            border: 1px solid #d1d5db;
            background-color: white;
            transition: all 0.15s;
        }
        .select-field:focus {
            border-color: #005bd3;
            box-shadow: 0 0 0 2px rgba(0, 91, 211, 0.2);
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">

<!-- AUTH BLOCK -->
<div id="auth-block"
     class="hidden max-w-xl mx-auto mt-20 bg-white shadow-lg rounded-xl p-8 text-center border border-gray-200">
    <h2 class="text-2xl font-semibold text-gray-800 mb-4">App Not Authorized</h2>
    <p class="text-gray-600 mb-6">This store has not completed Shopify authorization.</p>
    <a id="auth-link"
       class="inline-block bg-blue-600 hover:bg-blue-700 text-white font-medium px-6 py-3 rounded-lg transition">
        Authorize App
    </a>
</div>


<div id="subscription-view" class="hidden mt-8 w-full bg-white shadow-lg rounded-xl p-8 text-center border border-gray-200 max-w-5xl mx-auto">
    
    <h2 class="text-3xl font-bold text-gray-800 mb-4">Choose Your Plan</h2>
    <p class="text-gray-600 mb-8">
        Start for free with limited product schemas, or unlock unlimited schema power with Pro.
    </p>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">

        <!-- Free Plan -->
        <div class="border border-gray-300 rounded-xl p-6 hover:shadow-lg transition duration-200">
            <h3 class="text-xl font-semibold mb-2">Free Plan</h3>
            <p class="text-gray-600 mb-4">Always free</p>
            <p class="text-gray-800 font-bold text-2xl mb-4">$0</p>

            <ul class="text-left mb-6 space-y-2 text-gray-600">
                <li>✅ Up to 2 Product Schemas</li>
                <li>✅ Works on Product pages only</li>
                <li>✅ Core schema generation tools</li>
                <li>❌ No Collection schemas</li>
                <li>❌ No Blog or Page schemas</li>
                <li>❌ No advanced analytics</li>
            </ul>

            <a href="/subscribe/basic" 
               class="block bg-blue-600 hover:bg-blue-700 text-white py-2 px-4 rounded-lg">
                Continue with Free
            </a>
        </div>

        <!-- Pro Plan -->
        <div class="border-2 border-green-500 rounded-xl p-6 hover:shadow-xl transition duration-200 relative">

            <span class="absolute top-0 right-0 bg-green-500 text-white text-xs px-3 py-1 rounded-bl-xl rounded-tr-xl">
                MOST POPULAR
            </span>

            <h3 class="text-xl font-semibold mb-2 text-green-700">Pro Plan</h3>
            <p class="text-gray-600 mb-4">Full schema access</p>
            <p class="text-gray-800 font-bold text-2xl mb-4">$5 / month</p>

            <ul class="text-left mb-6 space-y-2 text-gray-600">
                <li>✅ Unlimited Product Schemas</li>
                <li>✅ Collection Schemas (coming soon)</li>
                <li>✅ Page Schemas (coming soon)</li>
                <li>✅ Blog Article Schemas (coming soon)</li>
                <li>✅ Advanced analytics</li>
                <li>✅ Priority support</li>
            </ul>

            <a href="/subscribe/pro" 
               class="block bg-green-600 hover:bg-green-700 text-white py-2 px-4 rounded-lg">
                Upgrade to Pro
            </a>
        </div>

    </div>

    <button id="backToAppBtn" 
            class="mt-8 bg-gray-500 hover:bg-gray-600 text-white py-2 px-4 rounded-lg">
        Back to App
    </button>

</div>


<!-- MAIN APP CONTAINER -->
<div id="app-container">


    <!-- PRODUCT SCHEMA MAPPING UI -->
    <div id="section-product" class="bg-white rounded-xl p-6 shadow-lg border border-gray-100 mb-8">
        <h3 class="text-2xl font-semibold text-gray-700 mb-6 border-b pb-3">Product Schema Generator</h3>
        <p style="margin-bottom: 1em;">
            <p class="text-gray-600 mb-6 leading-relaxed">
    Create powerful structured data for your Shopify products in minutes.
    Map your store’s existing fields and metafields to JSON-LD schema properties
    without touching code. Improve search visibility, enable rich results,
    and stay compliant with Google’s structured data guidelines — all from
    a simple visual interface.
</p>

        </p>
<td>
                <button id="toggleSubscriptionBtn" class="bg-purple-600 text-white px-4 py-2 rounded-lg mb-4">
                Manage Subscription
            </button>

    <span id="trial-status" class="ml-3 text-sm font-medium"></span>
</td>

        <div id="schema-mapping-container" class="space-y-4 mb-6"></div>
        <button id="addMappingBtn" class="bg-blue-600 hover:bg-blue-700 text-white py-2 px-4 rounded-lg shadow">+ Add Schema Mapping</button>
        <button id="sendToBackendBtn" class="bg-green-600 hover:bg-green-700 text-white py-2 px-4 rounded-lg shadow mt-4">Save & Generate Schema Metafields</button>
        <div id="metafields-preview" class="mt-4 text-sm text-gray-500"></div>
    </div>

    <!-- COLLECTION SCHEMA MAPPING UI -->
    <div id="section-collection" class="bg-white rounded-xl p-6 shadow-lg border border-gray-100 mb-8">
        <h3 class="text-2xl font-semibold text-gray-700 mb-6 border-b pb-3">Collection Schema Generator</h3>
        <div id="collection-mapping-container" class="space-y-4 mb-6"></div>
        <button id="addCollectionBtn" class="bg-blue-600 hover:bg-blue-700 text-white py-2 px-4 rounded-lg shadow">+ Add Schema Mapping</button>
        <button id="saveCollectionBtn" class="bg-green-600 hover:bg-green-700 text-white py-2 px-4 rounded-lg shadow mt-4">Save & Generate Collection Schema Metafields</button>
        <div id="collection-preview" class="mt-4 text-sm text-gray-500"></div>
    </div>

    <!-- BLOG SCHEMA MAPPING UI -->
    <div id="section-blog" class="bg-white rounded-xl p-6 shadow-lg border mb-8">
        <h3 class="text-2xl font-semibold text-gray-700 mb-6 border-b pb-3">Blog Schema Generator</h3>
        <div id="blog-mapping-container" class="space-y-4 mb-6"></div>
        <button id="addBlogBtn" class="bg-blue-600 hover:bg-blue-700 text-white py-2 px-4 rounded-lg shadow">+ Add Schema Mapping</button>
        <button id="saveBlogBtn" class="bg-green-600 hover:bg-green-700 text-white py-2 px-4 rounded-lg shadow mt-4">Save & Generate Blog Schema Metafields</button>
        <div id="blog-preview" class="mt-4 text-sm text-gray-500"></div>
    </div>

    <!-- PAGE SCHEMA MAPPING UI -->
    <div id="section-page" class="bg-white rounded-xl p-6 shadow-lg border mb-8">
        <h3 class="text-2xl font-semibold text-gray-700 mb-6 border-b pb-3">Page Schema Generator</h3>
        <div id="page-mapping-container" class="space-y-4 mb-6"></div>
        <button id="addPageBtn" class="bg-blue-600 hover:bg-blue-700 text-white py-2 px-4 rounded-lg shadow">+ Add Schema Mapping</button>
        <button id="savePageBtn" class="bg-green-600 hover:bg-green-700 text-white py-2 px-4 rounded-lg shadow mt-4">Save & Generate Page Schema Metafields</button>
        <div id="page-preview" class="mt-4 text-sm text-gray-500"></div>
    </div>

    <!-- HOMEPAGE SCHEMA MAPPING UI -->
    <div id="section-homepage" class="bg-white rounded-xl p-6 shadow-lg border mb-8">
        <h3 class="text-2xl font-semibold text-gray-700 mb-6 border-b pb-3">Homepage Schema Generator</h3>
        <div id="homepage-mapping-container" class="space-y-4 mb-6"></div>
        <button id="addHomepageBtn" class="bg-blue-600 hover:bg-blue-700 text-white py-2 px-4 rounded-lg shadow">+ Add Schema Mapping</button>
        <button id="saveHomepageBtn" class="bg-green-600 hover:bg-green-700 text-white py-2 px-4 rounded-lg shadow mt-4">Save & Generate Homepage Schema Metafields</button>
        <div id="homepage-preview" class="mt-4 text-sm text-gray-500"></div>
    </div>

</div> <!-- END APP CONTAINER -->


<!-- Upgrade Modal -->
<div id="upgradeModal" class="fixed inset-0 hidden items-center justify-center z-50">
  <!-- Overlay -->
  <div class="absolute inset-0 bg-black bg-opacity-40 backdrop-blur-sm"></div>

  <!-- Modal Card -->
  <div class="relative bg-white w-full max-w-md rounded-2xl shadow-2xl p-8 text-center z-10">

    <h2 class="text-2xl font-bold text-gray-800 mb-3">
      Upgrade Required
    </h2>

    <p class="text-gray-600 mb-6">
      The Free plan allows up to <strong>2 product schemas</strong>.
      Upgrade to Pro for unlimited product, collection, blog, and page schemas.
    </p>

    <div class="flex justify-center gap-4">
      <button id="closeUpgradeModal"
        class="px-5 py-2 rounded-lg border border-gray-300 text-gray-600 hover:bg-gray-100">
        Cancel
      </button>

      <button id="goUpgradeBtn"
        class="px-5 py-2 rounded-lg bg-purple-600 text-white hover:bg-purple-700">
        Upgrade to Pro
      </button>
    </div>
  </div>
</div>

<script>
    /* ================= PLAN STATE ================= */
const subscriptionInfo = {{ subscription_info | tojson | safe }};
const isPro =
    subscriptionInfo &&
    (
        subscriptionInfo.subscribed === true ||
        (Array.isArray(subscriptionInfo) && subscriptionInfo.length > 0)
    );
const isFree = !isPro;
/* ================= GLOBAL STATE ================= */
let collectionMappings = [];
let collectionRowId = 0;
let mappings = [];
let rowIdCounter = 0;
let pageRowId = 0;
let pageMappings = [];
let blogRowId = 0;
let blogMappings = [];
let homeRowId = 0;
let homeMappings = [];
/* ================= FIELD OPTIONS ================= */
const collectionFieldOptions = [
    "collection.title",
    "collection.handle",
    "collection.sort_order",
    "collection.updated_at",
    {% for mf in collection_metafields %}"metafield: {{ mf.node.namespace }}.{{ mf.node.key }}",{% endfor %}
];
const homepageFieldOptions = [
    "shop.name",
    "shop.domain",
    "shop.primary_domain",
    "shop.email",
    "shop.currency",
    "shop.description"
];
const productFieldOptions = [
    "product.title",
    "product.vendor",
    "product.handle",
    "product.product_type",
    "product.status",
    "product.description",
    {% for mf in product_metafields %}"metafield: {{ mf.node.namespace }}.{{ mf.node.key }}",{% endfor %}
];
/* ================= PAGE FIELD OPTIONS ================= */
const pageFieldOptions = [
    "page.title",
    "page.handle",
    "page.url",
    {% for mf in page_metafields %}
    "metafield: {{ mf.node.namespace }}.{{ mf.node.key }}",
    {% endfor %}
];

/* ================= BLOG FIELD OPTIONS ================= */
const blogFieldOptions = [
    "blog.title",
    "blog.handle",
    "blog.url",
    {% for mf in blog_metafields %}
    "metafield: {{ mf.node.namespace }}.{{ mf.node.key }}",
    {% endfor %}
];
const commonSchemaFields = {{ org_schema_fields | tojson }};

/* ================= CREATE ROW FUNCTIONS ================= */
function createCollectionRow(defaultSchema = "", defaultSource = "") {
    const schemaOptions = [...commonSchemaFields];
    if (defaultSchema && !commonSchemaFields.includes(defaultSchema)) schemaOptions.push(defaultSchema);

    const sourceOptions = [...collectionFieldOptions];
    if (defaultSource && !collectionFieldOptions.includes(defaultSource)) sourceOptions.push(defaultSource);

    const id = collectionRowId++;
    const container = document.getElementById("collection-mapping-container");

    const row = document.createElement("div");
    row.className = "flex gap-4 items-start bg-gray-50 p-4 rounded-lg border";
    row.dataset.rowId = id;

    row.innerHTML = `
        <div class="flex-1 flex flex-col gap-2">
            <label class="text-sm text-gray-600 font-medium">Schema Field</label>
            <select class="collection-schema-select p-2 border rounded bg-white">
                <option value="">Select Schema Field</option>
                ${schemaOptions.map(f => `<option value="${f}" ${f===defaultSchema?"selected":""}>${f}</option>`).join("")}
            </select>
            <input type="text" class="collection-schema-input p-2 border rounded" placeholder="Or write your own…" value="${defaultSchema && !commonSchemaFields.includes(defaultSchema)?defaultSchema:""}">
        </div>
        <div class="flex-1 flex flex-col gap-2">
            <label class="text-sm text-gray-600 font-medium">Shopify Source</label>
            <select class="collection-source p-2 border rounded bg-white">
                <option value="">Select Collection Attribute</option>
                ${sourceOptions.map(o => `<option value="${o}" ${o===defaultSource?"selected":""}>${o}</option>`).join("")}
            </select>
        </div>
        <button class="delete-collection-row bg-red-500 text-white px-3 py-2 rounded self-center">X</button>
    `;

    row.querySelector(".delete-collection-row").onclick = () => { row.remove(); updateCollectionMappings(); };
    row.querySelector(".collection-schema-select").onchange = updateCollectionMappings;
    row.querySelector(".collection-schema-input").oninput = updateCollectionMappings;
    row.querySelector(".collection-source").onchange = updateCollectionMappings;

    container.appendChild(row);
    updateCollectionMappings();
}
function createPageRow(defaultSchema = "", defaultSource = "") {
    const schemaOptions = [...commonSchemaFields];
    if (defaultSchema && !commonSchemaFields.includes(defaultSchema)) {
        schemaOptions.push(defaultSchema);
    }

    // Use the global pageFieldOptions array (includes metafields)
    const sourceOptions = [...pageFieldOptions];
    if (defaultSource && !pageFieldOptions.includes(defaultSource)) {
        sourceOptions.push(defaultSource);
    }

    const id = pageRowId++;
    const container = document.getElementById("page-mapping-container");

    const row = document.createElement("div");
    row.className = "flex gap-4 items-start bg-gray-50 p-4 rounded-lg border";
    row.dataset.rowId = id;

    row.innerHTML = `
        <div class="flex-1 flex flex-col gap-2">
            <label class="text-sm text-gray-600 font-medium">Schema Field</label>
            <select class="page-schema-select p-2 border rounded bg-white">
                <option value="">Select Schema Field</option>
                ${schemaOptions.map(f =>
                    `<option value="${f}" ${f === defaultSchema ? "selected" : ""}>${f}</option>`
                ).join("")}
            </select>
            <input
                type="text"
                class="page-schema-input p-2 border rounded"
                placeholder="Or write your own…"
                value="${defaultSchema && !commonSchemaFields.includes(defaultSchema) ? defaultSchema : ""}"
            >
        </div>

        <div class="flex-1 flex flex-col gap-2">
            <label class="text-sm text-gray-600 font-medium">Shopify Source</label>
            <select class="page-source p-2 border rounded bg-white">
                <option value="">Select Page Attribute</option>
                ${sourceOptions.map(o =>
                    `<option value="${o}" ${o === defaultSource ? "selected" : ""}>${o}</option>`
                ).join("")}
            </select>
        </div>

        <button class="delete-page-row bg-red-500 text-white px-3 py-2 rounded self-center">
            X
        </button>
    `;

    row.querySelector(".delete-page-row").onclick = () => {
        row.remove();
        updatePageMappings();
    };

    row.querySelector(".page-schema-select").onchange = updatePageMappings;
    row.querySelector(".page-schema-input").oninput = updatePageMappings;
    row.querySelector(".page-source").onchange = updatePageMappings;

    container.appendChild(row);
    updatePageMappings();
}


function updatePageMappings() {
    pageMappings = [...document.querySelectorAll("#page-mapping-container > div")]
        .map(row => ({
            schemaField:
                row.querySelector(".page-schema-input")?.value.trim()
                || row.querySelector(".page-schema-select")?.value.trim(),
            sourceField:
                row.querySelector(".page-source")?.value.trim()
        }))
        .filter(m => m.schemaField && m.sourceField);
}


function createBlogRow(defaultSchema = "", defaultSource = "") {
    const schemaOptions = [...commonSchemaFields];
    if (defaultSchema && !commonSchemaFields.includes(defaultSchema)) {
        schemaOptions.push(defaultSchema);
    }

    // Use the global blogFieldOptions array (includes metafields)
    const sourceOptions = [...blogFieldOptions];
    if (defaultSource && !blogFieldOptions.includes(defaultSource)) {
        sourceOptions.push(defaultSource);
    }

    const id = blogRowId++;
    const container = document.getElementById("blog-mapping-container");

    const row = document.createElement("div");
    row.className = "flex gap-4 items-start bg-gray-50 p-4 rounded-lg border";
    row.dataset.rowId = id;

    row.innerHTML = `
        <div class="flex-1 flex flex-col gap-2">
            <label class="text-sm text-gray-600 font-medium">Schema Field</label>
            <select class="blog-schema-select p-2 border rounded bg-white">
                <option value="">Select Schema Field</option>
                ${schemaOptions.map(f =>
                    `<option value="${f}" ${f === defaultSchema ? "selected" : ""}>${f}</option>`
                ).join("")}
            </select>
            <input
                type="text"
                class="blog-schema-input p-2 border rounded"
                placeholder="Or write your own…"
                value="${defaultSchema && !commonSchemaFields.includes(defaultSchema) ? defaultSchema : ""}"
            >
        </div>

        <div class="flex-1 flex flex-col gap-2">
            <label class="text-sm text-gray-600 font-medium">Shopify Source</label>
            <select class="blog-source p-2 border rounded bg-white">
                <option value="">Select Blog Attribute</option>
                ${sourceOptions.map(o =>
                    `<option value="${o}" ${o === defaultSource ? "selected" : ""}>${o}</option>`
                ).join("")}
            </select>
        </div>

        <button class="delete-blog-row bg-red-500 text-white px-3 py-2 rounded self-center">
            X
        </button>
    `;

    row.querySelector(".delete-blog-row").onclick = () => {
        row.remove();
        updateBlogMappings();
    };

    row.querySelector(".blog-schema-select").onchange = updateBlogMappings;
    row.querySelector(".blog-schema-input").oninput = updateBlogMappings;
    row.querySelector(".blog-source").onchange = updateBlogMappings;

    container.appendChild(row);
    updateBlogMappings();
}


function updateBlogMappings() {
    blogMappings = [...document.querySelectorAll("#blog-mapping-container > div")]
        .map(row => ({
            schemaField:
                row.querySelector(".blog-schema-input")?.value.trim()
                || row.querySelector(".blog-schema-select")?.value.trim(),
            sourceField:
                row.querySelector(".blog-source")?.value.trim()
        }))
        .filter(m => m.schemaField && m.sourceField);
}
function createHomepageRow(defaultSchema = "", defaultValue = "") {
    const schemaOptions = [...commonSchemaFields];
    if (defaultSchema && !commonSchemaFields.includes(defaultSchema)) {
        schemaOptions.push(defaultSchema);
    }

    const container = document.getElementById("homepage-mapping-container");

    const row = document.createElement("div");
    row.className = "flex gap-4 items-start bg-gray-50 p-4 rounded-lg border";

    row.innerHTML = `
        <div class="flex-1 flex flex-col gap-2">
            <label class="text-sm text-gray-600 font-medium">Schema Field</label>
            <select class="homepage-schema-select p-2 border rounded bg-white">
                <option value="">Select Schema Field</option>
                ${schemaOptions.map(f =>
                    `<option value="${f}" ${f === defaultSchema ? "selected" : ""}>${f}</option>`
                ).join("")}
            </select>
            <input
                type="text"
                class="homepage-schema-input p-2 border rounded"
                placeholder="Or write your own…"
                value="${defaultSchema && !commonSchemaFields.includes(defaultSchema) ? defaultSchema : ""}"
            >
        </div>

        <div class="flex-1 flex flex-col gap-2">
            <label class="text-sm text-gray-600 font-medium">Value</label>
            <input
                type="text"
                class="homepage-value p-2 border rounded"
                placeholder="Enter static value…"
                value="${defaultValue || ""}"
            >
        </div>

        <button class="delete-homepage-row bg-red-500 text-white px-3 py-2 rounded self-center">
            X
        </button>
    `;

    row.querySelector(".delete-homepage-row").onclick = () => {
        row.remove();
        updateHomepageMappings();
    };

    row.querySelector(".homepage-schema-select").onchange = updateHomepageMappings;
    row.querySelector(".homepage-schema-input").oninput = updateHomepageMappings;
    row.querySelector(".homepage-value").oninput = updateHomepageMappings;

    container.appendChild(row);
    updateHomepageMappings();
}


function updateHomepageMappings() {
    homeMappings = [...document.querySelectorAll("#homepage-mapping-container > div")]
        .map(row => ({
            schemaField:
                row.querySelector(".homepage-schema-input")?.value.trim()
                || row.querySelector(".homepage-schema-select")?.value.trim(),
            sourceField:
                row.querySelector(".homepage-value")?.value.trim()
        }))
        .filter(m => m.schemaField && m.sourceField);
}



    function createCollectionRow(defaultSchema = "", defaultSource = "") {
    const schemaOptions = [...commonSchemaFields];
    if (defaultSchema && !commonSchemaFields.includes(defaultSchema)) schemaOptions.push(defaultSchema);

    const sourceOptions = [...collectionFieldOptions];
    if (defaultSource && !collectionFieldOptions.includes(defaultSource)) sourceOptions.push(defaultSource);

    const id = collectionRowId++;
    const container = document.getElementById("collection-mapping-container");

    const row = document.createElement("div");
    row.className = "flex gap-4 items-start bg-gray-50 p-4 rounded-lg border";
    row.dataset.rowId = id;

    row.innerHTML = `
        <div class="flex-1 flex flex-col gap-2">
            <label class="text-sm text-gray-600 font-medium">Schema Field</label>
            <select class="collection-schema-select p-2 border rounded bg-white">
                <option value="">Select Schema Field</option>
                ${schemaOptions.map(f => `<option value="${f}" ${f===defaultSchema?"selected":""}>${f}</option>`).join("")}
            </select>
            <input type="text" class="collection-schema-input p-2 border rounded" placeholder="Or write your own…" value="${defaultSchema && !commonSchemaFields.includes(defaultSchema)?defaultSchema:""}">
        </div>
        <div class="flex-1 flex flex-col gap-2">
            <label class="text-sm text-gray-600 font-medium">Shopify Source</label>
            <select class="collection-source p-2 border rounded bg-white">
                <option value="">Select Collection Attribute</option>
                ${sourceOptions.map(o => `<option value="${o}" ${o===defaultSource?"selected":""}>${o}</option>`).join("")}
            </select>
        </div>
        <button class="delete-collection-row bg-red-500 text-white px-3 py-2 rounded self-center">X</button>
    `;

    row.querySelector(".delete-collection-row").onclick = () => { row.remove(); updateCollectionMappings(); };
    row.querySelector(".collection-schema-select").onchange = updateCollectionMappings;
    row.querySelector(".collection-schema-input").oninput = updateCollectionMappings;
    row.querySelector(".collection-source").onchange = updateCollectionMappings;

    container.appendChild(row);
    updateCollectionMappings();
}
function createSchemaRow(defaultSchema = "", defaultSource = "") {
    const schemaOptions = [...commonSchemaFields];

    const isCustom = defaultSchema && !commonSchemaFields.includes(defaultSchema);

    const sourceOptions = [...productFieldOptions];
    if (defaultSource && !productFieldOptions.includes(defaultSource)) {
        sourceOptions.push(defaultSource);
    }

    const id = rowIdCounter++;
    const container = document.getElementById("schema-mapping-container");

    const row = document.createElement("div");
    row.className = "flex gap-4 items-start bg-gray-50 p-4 rounded-lg border";
    row.dataset.rowId = id;

    row.innerHTML = `
        <div class="flex-1 flex flex-col gap-2">
            <label class="text-sm text-gray-600 font-medium">Schema Field</label>
            
            <select class="schema-select p-2 border rounded bg-white">
                <option value="">Select Schema Field</option>
                
                <!-- ✅ Custom is now SECOND -->
                <option value="__custom__" ${isCustom ? "selected" : ""}>
                    Custom…
                </option>

                ${schemaOptions.map(f => `
                    <option value="${f}" ${!isCustom && f === defaultSchema ? "selected" : ""}>
                        ${f}
                    </option>
                `).join("")}
            </select>

            <input 
                type="text"
                class="schema-input p-2 border rounded ${isCustom ? "" : "hidden"}"
                placeholder="Enter custom schema field…"
                value="${isCustom ? defaultSchema : ""}"
            >
        </div>

        <div class="flex-1 flex flex-col gap-2">
            <label class="text-sm text-gray-600 font-medium">Shopify Source</label>
            <select class="product-source p-2 border rounded bg-white">
                <option value="">Select Product Attribute</option>
                ${sourceOptions.map(o => `
                    <option value="${o}" ${o === defaultSource ? "selected" : ""}>
                        ${o}
                    </option>
                `).join("")}
            </select>
        </div>

        <button class="delete-row bg-red-500 text-white px-3 py-2 rounded self-center">
            X
        </button>
    `;

    const selectEl = row.querySelector(".schema-select");
    const inputEl = row.querySelector(".schema-input");

    // Toggle custom input visibility
    selectEl.addEventListener("change", () => {
        if (selectEl.value === "__custom__") {
            inputEl.classList.remove("hidden");
            inputEl.focus();
        } else {
            inputEl.classList.add("hidden");
            inputEl.value = "";
        }
        updateMappings();
    });

    row.querySelector(".delete-row").onclick = () => {
        row.remove();
        updateMappings();
    };

    row.querySelector(".product-source").onchange = updateMappings;
    inputEl.oninput = updateMappings;

    container.appendChild(row);
    updateMappings();
}



/* ================= UPDATE FUNCTIONS ================= */
function updateCollectionMappings() {
    collectionMappings = [...document.querySelectorAll("#collection-mapping-container > div")].map(row => ({
        schemaField: row.querySelector(".collection-schema-input").value.trim() || row.querySelector(".collection-schema-select").value.trim(),
        sourceField: row.querySelector(".collection-source").value.trim()
    }));
}

    function updateBlogMappings() {
    blogMappings = [...document.querySelectorAll("#blog-mapping-container > div")].map(row => ({
        schemaField: row.querySelector(".blog-schema-input").value.trim() || row.querySelector(".blog-schema-select").value.trim(),
        sourceField: row.querySelector(".blog-source").value.trim()
    }));
}

function updateMappings() {
    mappings = [...document.querySelectorAll("#schema-mapping-container > div")]
        .map(row => {
            const selectVal = row.querySelector(".schema-select").value;
            const customVal = row.querySelector(".schema-input").value.trim();

            return {
                schemaField: selectVal === "__custom__"
                    ? customVal
                    : selectVal,
                sourceField: row.querySelector(".product-source").value.trim()
            };
        })
        .filter(m => m.schemaField && m.sourceField);
}


/* ================= ADD BUTTONS ================= */
document.getElementById("addCollectionBtn").onclick = () => createCollectionRow();
    document.getElementById("addBlogBtn").onclick = () => createBlogRow();
        document.getElementById("addPageBtn").onclick = () => createPageRow();
document.getElementById("addMappingBtn").onclick = () => {
    const currentRows = document.querySelectorAll("#schema-mapping-container > div").length;

if (isFree && currentRows >= 2) {
    showUpgradeModal();
    return;
}


    createSchemaRow();
};

document.getElementById("addHomepageBtn").onclick = () => createHomepageRow();

/* ================= PREPOPULATE ================= */
const rawProductConfig = {{ product_config | tojson }};
const rawCollectionConfig = {{ collection_config | tojson }};
const rawBlogConfig = {{ blog_config | tojson }};    
const rawPageConfig = {{ page_config | tojson }};
    const rawHomepageConfig = {{ homepage_config | tojson }};

console.log("raw collection config:", JSON.stringify(rawCollectionConfig, null, 2));
    console.log("raw blog config:", JSON.stringify(rawBlogConfig, null, 2));
    console.log("raw page config:", JSON.stringify(rawPageConfig, null, 2));
    console.log("raw home config:", JSON.stringify(rawHomepageConfig, null, 2));
function normalizeMappings(input, key) {
    if (!input) return [];
    if (Array.isArray(input)) return input;
    if (typeof input === "object" && Array.isArray(input[key])) {
        return input[key];
    }
    return [];
}

const savedProductMappings = normalizeMappings(
    rawProductConfig?.product_schema_mappings,
    "product_schema_mappings"
);
const savedBlogMappings = normalizeMappings(
    rawBlogConfig?.blog_schema_mappings,
    "blog_schema_mappings"
);
const savedHomepageMappings = normalizeMappings(
    rawHomepageConfig?.homepage_schema_mappings,
    "homepage_schema_mappings"
);

console.log("saved homepage mappings:", JSON.stringify(savedHomepageMappings, null, 2));

    const savedPageMappings = normalizeMappings(
    rawPageConfig?.page_schema_mappings,
    "page_schema_mappings"
);

const savedCollectionMappings = normalizeMappings(
    rawCollectionConfig?.collection_schema_mappings,
    "collection_schema_mappings"
);
    console.log("saved page mappings:", JSON.stringify(savedPageMappings, null, 2));
    console.log("saved blog mappings:", JSON.stringify(savedBlogMappings, null, 2));
    console.log("saved colelction mappings:", JSON.stringify(savedCollectionMappings, null, 2));

/* ================= PREPOPULATE UI ================= */
if (savedBlogMappings.length > 0) {
    savedBlogMappings.forEach(m =>
        createBlogRow(m.schemaField || "", m.sourceField || "")
    );
} else {
    createBlogRow();
}
if (savedHomepageMappings.length > 0) {
    savedHomepageMappings.forEach(m =>
        createHomepageRow(m.schemaField || "", m.sourceField || "")
    );
} else {
    createHomepageRow();
}


if (savedPageMappings.length > 0) {
    savedPageMappings.forEach(m =>
        createPageRow(m.schemaField || "", m.sourceField || "")
    );
} else {
    createPageRow();
}


if (savedProductMappings.length > 0) {
    savedProductMappings.forEach(m =>
        createSchemaRow(m.schemaField || "", m.sourceField || "")
    );
} else {
    createSchemaRow();
}

if (savedCollectionMappings.length > 0) {
    savedCollectionMappings.forEach(m =>
        createCollectionRow(m.schemaField || "", m.sourceField || "")
    );
} else {
    createCollectionRow();
}


/* ================= SAVE HANDLERS ================= */
// Product Save Only
document.getElementById("sendToBackendBtn").onclick = async () => {
    const payload = buildFullPayload();
    const preview = document.getElementById("metafields-preview");
    preview.innerHTML = "Saving…";

    try {
        const resp = await fetch("/verify_and_create_metafields", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload)
        });
        const result = await resp.json();
        preview.innerHTML = resp.ok ? "Saved!" : `Error: ${result.error || JSON.stringify(result)}`;
    } catch {
        preview.innerHTML = "Network Error";
    }
};


// Collection Save Only
document.getElementById("saveCollectionBtn").onclick = async () => {
  const payload = buildFullPayload();
  const preview = document.getElementById("collection-preview");
  preview.innerHTML = "Saving…";

  try {
    const resp = await fetch("/verify_and_create_metafields", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    });

    const result = await resp.json();
    preview.innerHTML = resp.ok
      ? "Saved!"
      : `Error: ${result.error || JSON.stringify(result)}`;
  } catch {
    preview.innerHTML = "Network Error";
  }
};



    // Collection Save Only
document.getElementById("saveBlogBtn").onclick = async () => {
  const payload = buildFullPayload();
  const preview = document.getElementById("blog-preview");
  preview.innerHTML = "Saving…";

  try {
    const resp = await fetch("/verify_and_create_metafields", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    });
    const result = await resp.json();
    preview.innerHTML = resp.ok ? "Saved!" : `Error: ${result.error || JSON.stringify(result)}`;
  } catch {
    preview.innerHTML = "Network Error";
  }
};

document.getElementById("saveHomepageBtn").onclick = async () => {
  const payload = buildFullPayload();
  const preview = document.getElementById("homepage-preview");
  preview.innerHTML = "Saving…";

  try {
    const resp = await fetch("/verify_and_create_metafields", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    });

    const result = await resp.json();
    preview.innerHTML = resp.ok
      ? "Saved!"
      : `Error: ${result.error || JSON.stringify(result)}`;
  } catch {
    preview.innerHTML = "Network Error";
  }
};


 document.getElementById("savePageBtn").onclick = async () => {
  const payload = buildFullPayload();
  const preview = document.getElementById("page-preview");
  preview.innerHTML = "Saving…";

  try {
    const resp = await fetch("/verify_and_create_metafields", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    });

    const result = await resp.json();
    preview.innerHTML = resp.ok
      ? "Saved!"
      : `Error: ${result.error || JSON.stringify(result)}`;
  } catch {
    preview.innerHTML = "Network Error";
  }
};

// Optional Combined Save (if you ever add a "Save Both" button)
document.getElementById("saveBothBtn")?.addEventListener("click", async () => {
    updateMappings();
    updateCollectionMappings();
    updateBlogMappings();
    updatePageMappings();
    const payload = {
        shop: '{{ shop_name }}',
        hmac: '{{ hmac_value }}',
        id_token: '{{ id_token_value }}',
        product_schema_mappings: mappings,
        collection_schema_mappings: collectionMappings,
        page_schema_mappings: pageMappings,
        blog_schema_mappings: blogMappings,
        homepage_schema_mappings: homeMappings

    };
    const preview = document.getElementById("metafields-preview");
    preview.innerHTML = 'Saving…';

    try {
        const resp = await fetch("/verify_and_create_metafields", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload)
        });
        const result = await resp.json();
        preview.innerHTML = resp.ok ? `Saved!` : `Error: ${result.error || JSON.stringify(result)}`;
    } catch {
        preview.innerHTML = 'Network Error';
    }
});


    function buildFullPayload() {
    updateMappings();
    updateCollectionMappings();
    updateBlogMappings();
    updatePageMappings();

    return {
        shop: '{{ shop_name }}',
        hmac: '{{ hmac_value }}',
        id_token: '{{ id_token_value }}',
        product_schema_mappings: mappings,
        collection_schema_mappings: collectionMappings,
        blog_schema_mappings: blogMappings,
        page_schema_mappings: pageMappings,
        homepage_schema_mappings: homeMappings
    };
}


    /* ================= SECTION VISIBILITY ================= */

const sectionIds = [
  "product",
  "collection",
  "blog",
  "page",
  "homepage"
];

function showOnlySection(active) {
  sectionIds.forEach(name => {
    const el = document.getElementById(`section-${name}`);
    if (el) {
      el.style.display = name === active ? "block" : "none";
    }
  });
}

// default view
showOnlySection("product");

/* ================= FREE PLAN LOCK ================= */
if (isFree) {

  // Disable section dropdown options except product
  const sectionSelect = document.getElementById("schemaSectionSelect");
  if (sectionSelect) {
    [...sectionSelect.options].forEach(opt => {
      if (opt.value !== "product") {
        opt.disabled = true;
      }
    });
  }

  // If user somehow selects another section
  showOnlySection("product");
}

    
document.getElementById("schemaSectionSelect").addEventListener("change", e => {
  showOnlySection(e.target.value);
});


    /* ================= UPGRADE MODAL ================= */

function showUpgradeModal() {
    const modal = document.getElementById("upgradeModal");
    modal.classList.remove("hidden");
    modal.classList.add("flex");
}

function hideUpgradeModal() {
    const modal = document.getElementById("upgradeModal");
    modal.classList.add("hidden");
    modal.classList.remove("flex");
}


</script>

<script>
document.addEventListener("DOMContentLoaded", function () {

    const initDate = {{ shop_created_at | tojson }};
    const subscriptionInfo = {{ subscription_info | tojson | safe }};
    const needsAuth = {{ needs_auth | tojson }};

    const authBlock = document.getElementById("auth-block");
    const appContainer = document.getElementById("app-container");
    const subscriptionView = document.getElementById("subscription-view");
    const toggleBtn = document.getElementById("toggleSubscriptionBtn");
    const backBtn = document.getElementById("backToAppBtn");
    const trialEl = document.getElementById("trial-status");

    function getDaysSince(dateString) {
        if (!dateString) return 0;
        const created = new Date(dateString);
        const now = new Date();
        return Math.floor((now - created) / (1000 * 60 * 60 * 24));
    }

    const daysOld = getDaysSince(initDate);
    const trialExpired = daysOld > 15;

    const hasActiveSubscription =
        subscriptionInfo &&
        (
            subscriptionInfo.subscribed === true ||
            (Array.isArray(subscriptionInfo) && subscriptionInfo.length > 0)
        );

    console.log("Days old:", daysOld);
    console.log("Trial expired:", trialExpired);
    console.log("Subscribed:", hasActiveSubscription);
    console.log("Needs auth:", needsAuth);

    /* ================= AUTH ================= */
    if (needsAuth) {
        if (authBlock) authBlock.classList.remove("hidden");
        if (appContainer) appContainer.style.display = "none";
        return;
    } else {
        if (authBlock) authBlock.classList.add("hidden");
        if (appContainer) appContainer.style.display = "block";
    }

    /* ================= STATUS BADGE ================= */
    if (trialEl) {
        if (hasActiveSubscription) {
            trialEl.textContent = "Pro Plan Active";
            trialEl.className = "ml-3 text-sm font-medium text-green-600";
        } else if (!trialExpired) {
            trialEl.textContent = `Free Trial Active (${15 - daysOld} days left)`;
            trialEl.className = "ml-3 text-sm font-medium text-green-600";
        } else {
            trialEl.textContent = "Free Trial Expired";
            trialEl.className = "ml-3 text-sm font-medium text-red-600";
        }
    }

    /* ================= ACCESS CONTROL ================= */
    if (!hasActiveSubscription && trialExpired) {
        if (appContainer) appContainer.style.display = "none";
        if (subscriptionView) subscriptionView.classList.remove("hidden");
    } else {
        if (subscriptionView) subscriptionView.classList.add("hidden");
    }

    /* ================= TOGGLE ================= */
    if (toggleBtn && subscriptionView && appContainer) {
        toggleBtn.disabled = false;
        toggleBtn.classList.remove("opacity-50", "cursor-not-allowed");

        toggleBtn.addEventListener("click", () => {
            appContainer.style.display = "none";
            subscriptionView.classList.remove("hidden");
        });
    }

    if (backBtn && subscriptionView && appContainer) {
        backBtn.addEventListener("click", () => {
            subscriptionView.classList.add("hidden");
            appContainer.style.display = "block";
        });
    }



    /* ================= MODAL EVENTS ================= */

const closeUpgradeBtn = document.getElementById("closeUpgradeModal");
const goUpgradeBtn = document.getElementById("goUpgradeBtn");
const upgradeModal = document.getElementById("upgradeModal");

if (closeUpgradeBtn) {
    closeUpgradeBtn.addEventListener("click", hideUpgradeModal);
}

if (goUpgradeBtn) {
    goUpgradeBtn.addEventListener("click", () => {
        window.location.href = "/subscribe/pro"; // use your real route
    });
}

// Optional: click outside card closes modal
if (upgradeModal) {
    upgradeModal.addEventListener("click", (e) => {
        if (e.target === upgradeModal) {
            hideUpgradeModal();
        }
    });
}

    
});
</script>


</script>
</body>
</html>
