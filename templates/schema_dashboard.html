<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ title or "Schema App Dashboard" }}</title>
    <!-- Load Tailwind CSS via CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom font import for aesthetics */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body { font-family: 'Inter', sans-serif; }
        /* Style for the select element options */
        .select-field {
            padding: 4px 8px;
            border-radius: 4px;
            border: 1px solid #d1d5db;
            background-color: white;
            transition: all 0.15s;
        }
        .select-field:focus {
            border-color: #005bd3;
            box-shadow: 0 0 0 2px rgba(0, 91, 211, 0.2);
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">

<!-- PRODUCT SCHEMA MAPPING UI -->
<div class="bg-white rounded-xl p-6 shadow-lg border border-gray-100 mb-8">

    <h3 class="text-2xl font-semibold text-gray-700 mb-6 border-b pb-3">
        Product Schema Generator
    </h3>

    <!-- Empty container for mapping rows -->
    <div id="schema-mapping-container" class="space-y-4 mb-6">
        <!-- rows injected dynamically -->
    </div>

    <button id="addMappingBtn"
        class="bg-blue-600 hover:bg-blue-700 text-white py-2 px-4 rounded-lg shadow">
        + Add Schema Mapping
    </button>

    <button id="sendToBackendBtn"
        class="bg-green-600 hover:bg-green-700 text-white py-2 px-4 rounded-lg shadow mt-4">
        Save & Generate Schema Metafields
    </button>

    <!-- Status preview -->
    <div id="metafields-preview" class="mt-4 text-sm text-gray-500"></div>

</div>



    <!-- COLLECTION SCHEMA MAPPING UI -->
<div class="bg-white rounded-xl p-6 shadow-lg border border-gray-100 mb-8">

    <h3 class="text-2xl font-semibold text-gray-700 mb-6 border-b pb-3">
        Collection Schema Generator
    </h3>

    <div id="collection-mapping-container" class="space-y-4 mb-6"></div>

    <button id="addCollectionBtn"
        class="bg-blue-600 hover:bg-blue-700 text-white py-2 px-4 rounded-lg shadow">
        + Add Schema Mapping
    </button>

    <button id="saveCollectionBtn"
        class="bg-green-600 hover:bg-green-700 text-white py-2 px-4 rounded-lg shadow mt-4">
        Save & Generate Collection Schema Metafields
    </button>

    <div id="collection-preview" class="mt-4 text-sm text-gray-500"></div>
</div>

    <!-- BLOG SCHEMA MAPPING UI -->
<div class="bg-white rounded-xl p-6 shadow-lg border mb-8">
  <h3 class="text-2xl font-semibold text-gray-700 mb-6 border-b pb-3">
    Blog Schema Generator
  </h3>

  <div id="blog-mapping-container" class="space-y-4 mb-6"></div>

  <button id="addBlogBtn"
    class="bg-blue-600 hover:bg-blue-700 text-white py-2 px-4 rounded-lg shadow">
    + Add Schema Mapping
  </button>

  <button id="saveBlogBtn"
    class="bg-green-600 hover:bg-green-700 text-white py-2 px-4 rounded-lg shadow mt-4">
    Save & Generate Blog Schema Metafields
  </button>

  <div id="blog-preview" class="mt-4 text-sm text-gray-500"></div>
</div>



        <!-- PAGE SCHEMA MAPPING UI -->
<div class="bg-white rounded-xl p-6 shadow-lg border mb-8">
  <h3 class="text-2xl font-semibold text-gray-700 mb-6 border-b pb-3">
    Page Schema Generator
  </h3>

  <div id="page-mapping-container" class="space-y-4 mb-6"></div>

  <button id="addPageBtn"
    class="bg-blue-600 hover:bg-blue-700 text-white py-2 px-4 rounded-lg shadow">
    + Add Schema Mapping
  </button>

  <button id="savePageBtn"
    class="bg-green-600 hover:bg-green-700 text-white py-2 px-4 rounded-lg shadow mt-4">
    Save & Generate Page Schema Metafields
  </button>

  <div id="page-preview" class="mt-4 text-sm text-gray-500"></div>
</div>


    <!-- HOMEPAGE SCHEMA MAPPING UI -->
<div class="bg-white rounded-xl p-6 shadow-lg border mb-8">
  <h3 class="text-2xl font-semibold text-gray-700 mb-6 border-b pb-3">
    Homepage Schema Generator
  </h3>

  <div id="homepage-mapping-container" class="space-y-4 mb-6"></div>

  <button id="addHomepageBtn"
    class="bg-blue-600 hover:bg-blue-700 text-white py-2 px-4 rounded-lg shadow">
    + Add Schema Mapping
  </button>

  <button id="saveHomepageBtn"
    class="bg-green-600 hover:bg-green-700 text-white py-2 px-4 rounded-lg shadow mt-4">
    Save & Generate Homepage Schema Metafields
  </button>

  <div id="homepage-preview" class="mt-4 text-sm text-gray-500"></div>
</div>

<script>
/* ============================================================
   GLOBAL STATE
============================================================ */
let productMappings = [];
let collectionMappings = [];
let blogMappings = [];
let pageMappings = [];
let homepageMappings = [];

let rowId = 0, colRowId = 0, blogRowId = 0, pageRowId = 0, homeRowId = 0;

/* ============================================================
   HELPERS
============================================================ */
function val(el, a, b) {
  return el.querySelector(a).value.trim() || el.querySelector(b).value.trim();
}

function collect(container, schemaSel, schemaInp, sourceSel) {
  return [...document.querySelectorAll(container + " > div")].map(r => ({
    schemaField: val(r, schemaInp, schemaSel),
    sourceField: r.querySelector(sourceSel).value.trim()
  })).filter(m => m.schemaField && m.sourceField);
}

/* ============================================================
   UPDATE FUNCTIONS
============================================================ */
function updateAll() {
  productMappings = collect("#schema-mapping-container", ".schema-select", ".schema-input", ".product-source");
  collectionMappings = collect("#collection-mapping-container", ".collection-schema-select", ".collection-schema-input", ".collection-source");
  blogMappings = collect("#blog-mapping-container", ".blog-schema-select", ".blog-schema-input", ".blog-source");
  pageMappings = collect("#page-mapping-container", ".page-schema-select", ".page-schema-input", ".page-source");
  homepageMappings = collect("#homepage-mapping-container", ".homepage-schema-select", ".homepage-schema-input", ".homepage-source");
}

/* ============================================================
   SINGLE SAVE FUNCTION (CRITICAL FIX)
============================================================ */
async function saveEverything(previewEl) {
  updateAll();

  const payload = {
    shop: '{{ shop_name }}',
    hmac: '{{ hmac_value }}',
    id_token: '{{ id_token_value }}',
    product_schema_mappings: productMappings,
    collection_schema_mappings: collectionMappings,
    blog_schema_mappings: blogMappings,
    page_schema_mappings: pageMappings,
    homepage_schema_mappings: homepageMappings
  };

  previewEl.innerHTML = "Saving…";

  try {
    const r = await fetch("/verify_and_create_metafields", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    });
    const j = await r.json();
    previewEl.innerHTML = r.ok ? "Saved & Regenerated ✅" : `Error: ${j.error || "Unknown"}`;
  } catch {
    previewEl.innerHTML = "Network Error";
  }
}

/* ============================================================
   BUTTON WIRING — ALL SAVE BUTTONS DO THE SAME THING
============================================================ */
document.getElementById("sendToBackendBtn").onclick =
document.getElementById("saveCollectionBtn").onclick =
document.getElementById("saveBlogBtn").onclick =
document.getElementById("savePageBtn").onclick =
document.getElementById("saveHomepageBtn").onclick = () =>
  saveEverything(document.getElementById("metafields-preview"));

/* ============================================================
   PREPOPULATION (UNCHANGED — PRESERVED)
============================================================ */
function norm(v, k) {
  if (!v) return [];
  if (Array.isArray(v)) return v;
  if (typeof v === "object" && Array.isArray(v[k])) return v[k];
  return [];
}

const prodSaved = norm({{ product_config | tojson }}?.product_schema_mappings, "product_schema_mappings");
const colSaved  = norm({{ collection_config | tojson }}?.collection_schema_mappings, "collection_schema_mappings");

(prodSaved.length ? prodSaved : [{}]).forEach(m => createSchemaRow(m.schemaField || "", m.sourceField || ""));
(colSaved.length ? colSaved : [{}]).forEach(m => createCollectionRow(m.schemaField || "", m.sourceField || ""));
</script>


</body>
</html>
