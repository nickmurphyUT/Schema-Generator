<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ title or "Schema App Dashboard" }}</title>
    <!-- Load Tailwind CSS via CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom font import for aesthetics */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body { font-family: 'Inter', sans-serif; }
        /* Style for the select element options */
        .select-field {
            padding: 4px 8px;
            border-radius: 4px;
            border: 1px solid #d1d5db;
            background-color: white;
            transition: all 0.15s;
        }
        .select-field:focus {
            border-color: #005bd3;
            box-shadow: 0 0 0 2px rgba(0, 91, 211, 0.2);
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">

<!-- PRODUCT SCHEMA MAPPING UI -->
<div class="bg-white rounded-xl p-6 shadow-lg border border-gray-100 mb-8">

    <h3 class="text-2xl font-semibold text-gray-700 mb-6 border-b pb-3">
        Product Schema Generator
    </h3>

    <!-- Empty container for mapping rows -->
    <div id="schema-mapping-container" class="space-y-4 mb-6">
        <!-- rows injected dynamically -->
    </div>

    <button id="addMappingBtn"
        class="bg-blue-600 hover:bg-blue-700 text-white py-2 px-4 rounded-lg shadow">
        + Add Schema Mapping
    </button>

    <button id="sendToBackendBtn"
        class="bg-green-600 hover:bg-green-700 text-white py-2 px-4 rounded-lg shadow mt-4">
        Save & Generate Schema Metafields
    </button>

    <!-- Status preview -->
    <div id="metafields-preview" class="mt-4 text-sm text-gray-500"></div>

</div>



    <!-- COLLECTION SCHEMA MAPPING UI -->
<div class="bg-white rounded-xl p-6 shadow-lg border border-gray-100 mb-8">

    <h3 class="text-2xl font-semibold text-gray-700 mb-6 border-b pb-3">
        Collection Schema Generator
    </h3>

    <div id="collection-mapping-container" class="space-y-4 mb-6"></div>

    <button id="addCollectionBtn"
        class="bg-blue-600 hover:bg-blue-700 text-white py-2 px-4 rounded-lg shadow">
        + Add Schema Mapping
    </button>

    <button id="saveCollectionBtn"
        class="bg-green-600 hover:bg-green-700 text-white py-2 px-4 rounded-lg shadow mt-4">
        Save & Generate Collection Schema Metafields
    </button>

    <div id="collection-preview" class="mt-4 text-sm text-gray-500"></div>
</div>

    <!-- BLOG SCHEMA MAPPING UI -->
<div class="bg-white rounded-xl p-6 shadow-lg border mb-8">
  <h3 class="text-2xl font-semibold text-gray-700 mb-6 border-b pb-3">
    Blog Schema Generator
  </h3>

  <div id="blog-mapping-container" class="space-y-4 mb-6"></div>

  <button id="addBlogBtn"
    class="bg-blue-600 hover:bg-blue-700 text-white py-2 px-4 rounded-lg shadow">
    + Add Schema Mapping
  </button>

  <button id="saveBlogBtn"
    class="bg-green-600 hover:bg-green-700 text-white py-2 px-4 rounded-lg shadow mt-4">
    Save & Generate Blog Schema Metafields
  </button>

  <div id="blog-preview" class="mt-4 text-sm text-gray-500"></div>
</div>



        <!-- PAGE SCHEMA MAPPING UI -->
<div class="bg-white rounded-xl p-6 shadow-lg border mb-8">
  <h3 class="text-2xl font-semibold text-gray-700 mb-6 border-b pb-3">
    Page Schema Generator
  </h3>

  <div id="page-mapping-container" class="space-y-4 mb-6"></div>

  <button id="addPageBtn"
    class="bg-blue-600 hover:bg-blue-700 text-white py-2 px-4 rounded-lg shadow">
    + Add Schema Mapping
  </button>

  <button id="savePageBtn"
    class="bg-green-600 hover:bg-green-700 text-white py-2 px-4 rounded-lg shadow mt-4">
    Save & Generate Page Schema Metafields
  </button>

  <div id="page-preview" class="mt-4 text-sm text-gray-500"></div>
</div>


    <!-- HOMEPAGE SCHEMA MAPPING UI -->
<div class="bg-white rounded-xl p-6 shadow-lg border mb-8">
  <h3 class="text-2xl font-semibold text-gray-700 mb-6 border-b pb-3">
    Homepage Schema Generator
  </h3>

  <div id="homepage-mapping-container" class="space-y-4 mb-6"></div>

  <button id="addHomepageBtn"
    class="bg-blue-600 hover:bg-blue-700 text-white py-2 px-4 rounded-lg shadow">
    + Add Schema Mapping
  </button>

  <button id="saveHomepageBtn"
    class="bg-green-600 hover:bg-green-700 text-white py-2 px-4 rounded-lg shadow mt-4">
    Save & Generate Homepage Schema Metafields
  </button>

  <div id="homepage-preview" class="mt-4 text-sm text-gray-500"></div>
</div>

<script>
/* ============================================================
   GLOBAL STATE
============================================================ */
let mappings = [];
let collectionMappings = [];
let blogMappings = [];
let pageMappings = [];
let homepageMappings = [];

/* ============================================================
   FIELD OPTIONS (SERVER)
============================================================ */
const productFieldOptions = [
  "product.title",
  "product.vendor",
  "product.handle",
  "product.product_type",
  "product.status",
  "product.description",
  "product.tags[]",
  {% for mf in product_metafields %}"metafield: {{ mf.node.namespace }}.{{ mf.node.key }}",{% endfor %}
];

const collectionFieldOptions = [
  "collection.title",
  "collection.handle",
  {% for mf in collection_metafields %}"metafield: {{ mf.node.namespace }}.{{ mf.node.key }}",{% endfor %}
];

const blogFieldOptions = [
  "blog.title",
  "blog.handle",
  {% for mf in blog_metafields %}"metafield: {{ mf.node.namespace }}.{{ mf.node.key }}",{% endfor %}
];

const pageFieldOptions = [
  "page.title",
  "page.handle",
  "page.body_html",
  {% for mf in page_metafields %}"metafield: {{ mf.node.namespace }}.{{ mf.node.key }}",{% endfor %}
];

/* homepage metafields DO NOT EXIST SERVER SIDE — keep safe */
const homepageFieldOptions = [
  "homepage.title",
  "homepage.meta_title",
  "homepage.meta_description"
];

const commonSchemaFields = {{ org_schema_fields | tojson }};

/* ============================================================
   HELPERS
============================================================ */
function normalize(input, key) {
  if (!input) return [];
  if (Array.isArray(input)) return input;
  if (typeof input === "object" && Array.isArray(input[key])) return input[key];
  return [];
}

function collect(container, schemaInput, schemaSelect, sourceSelect) {
  return [...document.querySelectorAll(container + " > div")].map(row => ({
    schemaField:
      row.querySelector(schemaInput).value.trim() ||
      row.querySelector(schemaSelect).value.trim(),
    sourceField: row.querySelector(sourceSelect).value.trim()
  }));
}

/* ============================================================
   ROW FACTORY
============================================================ */
function createRow({ containerId, schemaClass, inputClass, sourceClass, sourceOptions, a="", b="", onUpdate }) {
  const row = document.createElement("div");
  row.className = "flex gap-4 p-4 bg-gray-50 border rounded";

  row.innerHTML = `
    <div class="flex-1">
      <select class="${schemaClass}">
        <option value="">Select Schema Field</option>
        ${commonSchemaFields.map(f => `<option ${f===a?"selected":""}>${f}</option>`).join("")}
      </select>
      <input class="${inputClass}" value="${a}">
    </div>
    <div class="flex-1">
      <select class="${sourceClass}">
        <option value="">Select Source</option>
        ${sourceOptions.map(s => `<option ${s===b?"selected":""}>${s}</option>`).join("")}
      </select>
    </div>
    <button class="delete-row">X</button>
  `;

  row.querySelector(".delete-row").onclick = () => { row.remove(); onUpdate(); };
  row.querySelectorAll("select,input").forEach(el => el.onchange = onUpdate);

  document.getElementById(containerId).appendChild(row);
  onUpdate();
}

/* ============================================================
   ROW CREATORS
============================================================ */
const createSchemaRow = (a,b)=>createRow({
  containerId:"schema-mapping-container",
  schemaClass:"schema-select",
  inputClass:"schema-input",
  sourceClass:"product-source",
  sourceOptions:productFieldOptions,
  a,b,onUpdate:()=>mappings=collect("#schema-mapping-container",".schema-input",".schema-select",".product-source")
});

const createCollectionRow = (a,b)=>createRow({
  containerId:"collection-mapping-container",
  schemaClass:"collection-schema-select",
  inputClass:"collection-schema-input",
  sourceClass:"collection-source",
  sourceOptions:collectionFieldOptions,
  a,b,onUpdate:()=>collectionMappings=collect("#collection-mapping-container",".collection-schema-input",".collection-schema-select",".collection-source")
});

const createBlogRow = (a,b)=>createRow({
  containerId:"blog-mapping-container",
  schemaClass:"blog-schema-select",
  inputClass:"blog-schema-input",
  sourceClass:"blog-source",
  sourceOptions:blogFieldOptions,
  a,b,onUpdate:()=>blogMappings=collect("#blog-mapping-container",".blog-schema-input",".blog-schema-select",".blog-source")
});

const createPageRow = (a,b)=>createRow({
  containerId:"page-mapping-container",
  schemaClass:"page-schema-select",
  inputClass:"page-schema-input",
  sourceClass:"page-source",
  sourceOptions:pageFieldOptions,
  a,b,onUpdate:()=>pageMappings=collect("#page-mapping-container",".page-schema-input",".page-schema-select",".page-source")
});

const createHomepageRow = (a,b)=>createRow({
  containerId:"homepage-mapping-container",
  schemaClass:"homepage-schema-select",
  inputClass:"homepage-schema-input",
  sourceClass:"homepage-source",
  sourceOptions:homepageFieldOptions,
  a,b,onUpdate:()=>homepageMappings=collect("#homepage-mapping-container",".homepage-schema-input",".homepage-schema-select",".homepage-source")
});

/* ============================================================
   PREPOPULATION (THIS WAS MISSING)
============================================================ */
normalize({{ product_config|tojson }},"product_schema_mappings")
  .forEach(m=>createSchemaRow(m.schemaField,m.sourceField));

normalize({{ collection_config|tojson }},"collection_schema_mappings")
  .forEach(m=>createCollectionRow(m.schemaField,m.sourceField));

normalize({{ blog_config|tojson }},"blog_schema_mappings")
  .forEach(m=>createBlogRow(m.schemaField,m.sourceField));

normalize({{ page_config|tojson }},"page_schema_mappings")
  .forEach(m=>createPageRow(m.schemaField,m.sourceField));

/* ============================================================
   SAVE
============================================================ */
async function save(payload, preview) {
  document.getElementById(preview).innerText="Saving…";
  const r = await fetch("/verify_and_create_metafields",{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify(payload)
  });
  document.getElementById(preview).innerText = r.ok ? "Saved!" : "Error";
}

document.getElementById("sendToBackendBtn").onclick = ()=>save({product_schema_mappings:mappings},"metafields-preview");
document.getElementById("saveCollectionBtn").onclick = ()=>save({collection_schema_mappings:collectionMappings},"collection-preview");
document.getElementById("saveBlogBtn").onclick = ()=>save({blog_schema_mappings:blogMappings},"blog-preview");
document.getElementById("savePageBtn").onclick = ()=>save({page_schema_mappings:pageMappings},"page-preview");
document.getElementById("saveHomepageBtn").onclick = ()=>save({homepage_schema_mappings:homepageMappings},"homepage-preview");
</script>

</body>
</html>
