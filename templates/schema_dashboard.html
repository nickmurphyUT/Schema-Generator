<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ title or "Schema App Dashboard" }}</title>
    <!-- Load Tailwind CSS via CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom font import for aesthetics */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body { font-family: 'Inter', sans-serif; }
        /* Style for the select element options */
        .select-field {
            padding: 4px 8px;
            border-radius: 4px;
            border: 1px solid #d1d5db;
            background-color: white;
            transition: all 0.15s;
        }
        .select-field:focus {
            border-color: #005bd3;
            box-shadow: 0 0 0 2px rgba(0, 91, 211, 0.2);
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">

<!-- PRODUCT SCHEMA MAPPING UI -->
<div class="bg-white rounded-xl p-6 shadow-lg border border-gray-100 mb-8">

    <h3 class="text-2xl font-semibold text-gray-700 mb-6 border-b pb-3">
        Product Schema Generator
    </h3>

    <!-- Empty container for mapping rows -->
    <div id="schema-mapping-container" class="space-y-4 mb-6">
        <!-- rows injected dynamically -->
    </div>

    <button id="addMappingBtn"
        class="bg-blue-600 hover:bg-blue-700 text-white py-2 px-4 rounded-lg shadow">
        + Add Schema Mapping
    </button>

    <button id="sendToBackendBtn"
        class="bg-green-600 hover:bg-green-700 text-white py-2 px-4 rounded-lg shadow mt-4">
        Save & Generate Schema Metafields
    </button>

    <!-- Status preview -->
    <div id="metafields-preview" class="mt-4 text-sm text-gray-500"></div>

</div>



    <!-- COLLECTION SCHEMA MAPPING UI -->
<div class="bg-white rounded-xl p-6 shadow-lg border border-gray-100 mb-8">

    <h3 class="text-2xl font-semibold text-gray-700 mb-6 border-b pb-3">
        Collection Schema Generator
    </h3>

    <div id="collection-mapping-container" class="space-y-4 mb-6"></div>

    <button id="addCollectionBtn"
        class="bg-blue-600 hover:bg-blue-700 text-white py-2 px-4 rounded-lg shadow">
        + Add Schema Mapping
    </button>

    <button id="saveCollectionBtn"
        class="bg-green-600 hover:bg-green-700 text-white py-2 px-4 rounded-lg shadow mt-4">
        Save & Generate Collection Schema Metafields
    </button>

    <div id="collection-preview" class="mt-4 text-sm text-gray-500"></div>
</div>

    <!-- BLOG SCHEMA MAPPING UI -->
<div class="bg-white rounded-xl p-6 shadow-lg border mb-8">
  <h3 class="text-2xl font-semibold text-gray-700 mb-6 border-b pb-3">
    Blog Schema Generator
  </h3>

  <div id="blog-mapping-container" class="space-y-4 mb-6"></div>

  <button id="addBlogBtn"
    class="bg-blue-600 hover:bg-blue-700 text-white py-2 px-4 rounded-lg shadow">
    + Add Schema Mapping
  </button>

  <button id="saveBlogBtn"
    class="bg-green-600 hover:bg-green-700 text-white py-2 px-4 rounded-lg shadow mt-4">
    Save & Generate Blog Schema Metafields
  </button>

  <div id="blog-preview" class="mt-4 text-sm text-gray-500"></div>
</div>



        <!-- PAGE SCHEMA MAPPING UI -->
<div class="bg-white rounded-xl p-6 shadow-lg border mb-8">
  <h3 class="text-2xl font-semibold text-gray-700 mb-6 border-b pb-3">
    Page Schema Generator
  </h3>

  <div id="page-mapping-container" class="space-y-4 mb-6"></div>

  <button id="addPageBtn"
    class="bg-blue-600 hover:bg-blue-700 text-white py-2 px-4 rounded-lg shadow">
    + Add Schema Mapping
  </button>

  <button id="savePageBtn"
    class="bg-green-600 hover:bg-green-700 text-white py-2 px-4 rounded-lg shadow mt-4">
    Save & Generate Page Schema Metafields
  </button>

  <div id="page-preview" class="mt-4 text-sm text-gray-500"></div>
</div>


    <!-- HOMEPAGE SCHEMA MAPPING UI -->
<div class="bg-white rounded-xl p-6 shadow-lg border mb-8">
  <h3 class="text-2xl font-semibold text-gray-700 mb-6 border-b pb-3">
    Homepage Schema Generator
  </h3>

  <div id="homepage-mapping-container" class="space-y-4 mb-6"></div>

  <button id="addHomepageBtn"
    class="bg-blue-600 hover:bg-blue-700 text-white py-2 px-4 rounded-lg shadow">
    + Add Schema Mapping
  </button>

  <button id="saveHomepageBtn"
    class="bg-green-600 hover:bg-green-700 text-white py-2 px-4 rounded-lg shadow mt-4">
    Save & Generate Homepage Schema Metafields
  </button>

  <div id="homepage-preview" class="mt-4 text-sm text-gray-500"></div>
</div>

<script>
/* ============================================================
   GLOBAL STATE
============================================================ */
let mappings = [];
let collectionMappings = [];
let blogMappings = [];
let pageMappings = [];
let homepageMappings = [];

let rowIdCounter = 0;
let collectionRowId = 0;
let blogRowId = 0;
let pageRowId = 0;
let homepageRowId = 0;

/* ============================================================
   FIELD OPTIONS (FROM SERVER)
============================================================ */
const productFieldOptions = [
  "product.title",
  "product.vendor",
  "product.handle",
  "product.product_type",
  "product.status",
  "product.description",
  "product.tags[]",
  "product.images[].src",
  "variants[].sku",
  "variants[].price",
  "variants[].barcode",
  "variants[].weight",
  {% for mf in product_metafields %}"metafield: {{ mf.node.namespace }}.{{ mf.node.key }}",{% endfor %}
];

const collectionFieldOptions = [
  "collection.title",
  "collection.handle",
  "collection.sort_order",
  "collection.updated_at",
  {% for mf in collection_metafields %}"metafield: {{ mf.node.namespace }}.{{ mf.node.key }}",{% endfor %}
];

const blogFieldOptions = [
  "blog.title",
  "blog.handle",
  "blog.updated_at",
  "blog.comments_enabled",
  {% for mf in blog_metafields %}"metafield: {{ mf.node.namespace }}.{{ mf.node.key }}",{% endfor %}
];

const pageFieldOptions = [
  "page.title",
  "page.handle",
  "page.published_at",
  "page.updated_at",
  "page.body_html",
  {% for mf in page_metafields %}"metafield: {{ mf.node.namespace }}.{{ mf.node.key }}",{% endfor %}
];

const homepageFieldOptions = [
  "homepage.title",
  "homepage.meta_title",
  "homepage.meta_description",
  "homepage.updated_at",
  {% for mf in homepage_metafields %}"metafield: {{ mf.node.namespace }}.{{ mf.node.key }}",{% endfor %}
];

const commonSchemaFields = {{ org_schema_fields | tojson }};

/* ============================================================
   HELPERS
============================================================ */
function normalizeMappings(input, key) {
  if (!input) return [];
  if (Array.isArray(input)) return input;
  if (typeof input === "object" && Array.isArray(input[key])) return input[key];
  return [];
}

function collect(containerSelector, schemaInput, schemaSelect, sourceSelect) {
  return [...document.querySelectorAll(`${containerSelector} > div`)].map(row => ({
    schemaField:
      row.querySelector(schemaInput).value.trim() ||
      row.querySelector(schemaSelect).value.trim(),
    sourceField:
      row.querySelector(sourceSelect).value.trim()
  }));
}

/* ============================================================
   UPDATE FUNCTIONS (SOURCE OF TRUTH)
============================================================ */
function updateMappings() {
  mappings = collect(
    "#schema-mapping-container",
    ".schema-input",
    ".schema-select",
    ".product-source"
  );
}

function updateCollectionMappings() {
  collectionMappings = collect(
    "#collection-mapping-container",
    ".collection-schema-input",
    ".collection-schema-select",
    ".collection-source"
  );
}

function updateBlogMappings() {
  blogMappings = collect(
    "#blog-mapping-container",
    ".blog-schema-input",
    ".blog-schema-select",
    ".blog-source"
  );
}

function updatePageMappings() {
  pageMappings = collect(
    "#page-mapping-container",
    ".page-schema-input",
    ".page-schema-select",
    ".page-source"
  );
}

function updateHomepageMappings() {
  homepageMappings = collect(
    "#homepage-mapping-container",
    ".homepage-schema-input",
    ".homepage-schema-select",
    ".homepage-source"
  );
}

/* ============================================================
   ROW FACTORY (GENERIC)
============================================================ */
function createRow({
  containerId,
  schemaClass,
  inputClass,
  sourceClass,
  sourceOptions,
  defaultSchema = "",
  defaultSource = "",
  onUpdate
}) {
  const schemaOptions = [...commonSchemaFields];
  if (defaultSchema && !schemaOptions.includes(defaultSchema)) schemaOptions.push(defaultSchema);

  const sources = [...sourceOptions];
  if (defaultSource && !sources.includes(defaultSource)) sources.push(defaultSource);

  const row = document.createElement("div");
  row.className = "flex gap-4 items-start bg-gray-50 p-4 rounded-lg border";

  row.innerHTML = `
    <div class="flex-1 flex flex-col gap-2">
      <label class="text-sm text-gray-600 font-medium">Schema Field</label>
      <select class="${schemaClass} p-2 border rounded bg-white">
        <option value="">Select Schema Field</option>
        ${schemaOptions.map(f => `<option value="${f}" ${f===defaultSchema?"selected":""}>${f}</option>`).join("")}
      </select>
      <input class="${inputClass} p-2 border rounded" placeholder="Or write your own…" value="${defaultSchema && !commonSchemaFields.includes(defaultSchema)?defaultSchema:""}">
    </div>
    <div class="flex-1 flex flex-col gap-2">
      <label class="text-sm text-gray-600 font-medium">Source</label>
      <select class="${sourceClass} p-2 border rounded bg-white">
        <option value="">Select Source</option>
        ${sources.map(s => `<option value="${s}" ${s===defaultSource?"selected":""}>${s}</option>`).join("")}
      </select>
    </div>
    <button class="delete-row bg-red-500 text-white px-3 py-2 rounded self-center">X</button>
  `;

  row.querySelector(".delete-row").onclick = () => {
    row.remove();
    onUpdate();
  };

  row.querySelector(`.${schemaClass}`).onchange = onUpdate;
  row.querySelector(`.${inputClass}`).oninput = onUpdate;
  row.querySelector(`.${sourceClass}`).onchange = onUpdate;

  document.getElementById(containerId).appendChild(row);
  onUpdate();
}

/* ============================================================
   ROW CREATORS
============================================================ */
function createSchemaRow(a="",b="") {
  createRow({
    containerId: "schema-mapping-container",
    schemaClass: "schema-select",
    inputClass: "schema-input",
    sourceClass: "product-source",
    sourceOptions: productFieldOptions,
    defaultSchema: a,
    defaultSource: b,
    onUpdate: updateMappings
  });
}

function createCollectionRow(a="",b="") {
  createRow({
    containerId: "collection-mapping-container",
    schemaClass: "collection-schema-select",
    inputClass: "collection-schema-input",
    sourceClass: "collection-source",
    sourceOptions: collectionFieldOptions,
    defaultSchema: a,
    defaultSource: b,
    onUpdate: updateCollectionMappings
  });
}

function createBlogRow(a="",b="") {
  createRow({
    containerId: "blog-mapping-container",
    schemaClass: "blog-schema-select",
    inputClass: "blog-schema-input",
    sourceClass: "blog-source",
    sourceOptions: blogFieldOptions,
    defaultSchema: a,
    defaultSource: b,
    onUpdate: updateBlogMappings
  });
}

function createPageRow(a="",b="") {
  createRow({
    containerId: "page-mapping-container",
    schemaClass: "page-schema-select",
    inputClass: "page-schema-input",
    sourceClass: "page-source",
    sourceOptions: pageFieldOptions,
    defaultSchema: a,
    defaultSource: b,
    onUpdate: updatePageMappings
  });
}

function createHomepageRow(a="",b="") {
  createRow({
    containerId: "homepage-mapping-container",
    schemaClass: "homepage-schema-select",
    inputClass: "homepage-schema-input",
    sourceClass: "homepage-source",
    sourceOptions: homepageFieldOptions,
    defaultSchema: a,
    defaultSource: b,
    onUpdate: updateHomepageMappings
  });
}

/* ============================================================
   PREPOPULATION (UNCHANGED, FIXED)
============================================================ */
const rawProductConfig = {{ product_config | tojson }};
const rawCollectionConfig = {{ collection_config | tojson }};

normalizeMappings(rawProductConfig?.product_schema_mappings, "product_schema_mappings")
  .forEach(m => createSchemaRow(m.schemaField, m.sourceField));

normalizeMappings(rawCollectionConfig?.collection_schema_mappings, "collection_schema_mappings")
  .forEach(m => createCollectionRow(m.schemaField, m.sourceField));

if (!mappings.length) createSchemaRow();
if (!collectionMappings.length) createCollectionRow();

/* ============================================================
   SAVE HANDLERS (NO OVERWRITES)
============================================================ */
async function save(payload, previewId) {
  const el = document.getElementById(previewId);
  el.innerHTML = "Saving…";
  try {
    const r = await fetch("/verify_and_create_metafields", {
      method: "POST",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify(payload)
    });
    const j = await r.json();
    el.innerHTML = r.ok ? "Saved!" : `Error: ${j.error || "Unknown error"}`;
  } catch {
    el.innerHTML = "Network Error";
  }
}

document.getElementById("sendToBackendBtn").onclick = () => {
  updateMappings();
  save({
    shop:'{{ shop_name }}',
    hmac:'{{ hmac_value }}',
    id_token:'{{ id_token_value }}',
    product_schema_mappings: mappings
  }, "metafields-preview");
};

document.getElementById("saveCollectionBtn").onclick = () => {
  updateCollectionMappings();
  save({
    shop:'{{ shop_name }}',
    hmac:'{{ hmac_value }}',
    id_token:'{{ id_token_value }}',
    collection_schema_mappings: collectionMappings
  }, "collection-preview");
};

document.getElementById("saveBlogBtn").onclick = () => {
  updateBlogMappings();
  save({
    shop:'{{ shop_name }}',
    hmac:'{{ hmac_value }}',
    id_token:'{{ id_token_value }}',
    blog_schema_mappings: blogMappings
  }, "blog-preview");
};

document.getElementById("savePageBtn").onclick = () => {
  updatePageMappings();
  save({
    shop:'{{ shop_name }}',
    hmac:'{{ hmac_value }}',
    id_token:'{{ id_token_value }}',
    page_schema_mappings: pageMappings
  }, "page-preview");
};

document.getElementById("saveHomepageBtn").onclick = () => {
  updateHomepageMappings();
  save({
    shop:'{{ shop_name }}',
    hmac:'{{ hmac_value }}',
    id_token:'{{ id_token_value }}',
    homepage_schema_mappings: homepageMappings
  }, "homepage-preview");
};

/* ============================================================
   ADD BUTTONS
============================================================ */
document.getElementById("addMappingBtn").onclick = () => createSchemaRow();
document.getElementById("addCollectionBtn").onclick = () => createCollectionRow();
document.getElementById("addBlogBtn").onclick = () => createBlogRow();
document.getElementById("addPageBtn").onclick = () => createPageRow();
document.getElementById("addHomepageBtn").onclick = () => createHomepageRow();
</script>


</body>
</html>
